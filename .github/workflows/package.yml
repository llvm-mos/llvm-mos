name: package
on: [push]
jobs:
  package:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-self-hosted, macos-self-hosted]
    env:
      GH_REPO: llvm-mos/llvm-mos
    steps:
      - name: Remove workspace
        uses: JesseTG/rm@v1.0.2
        with:
          path: ${{ github.workspace }}/*
      - name: Check out source code
        uses: actions/checkout@v2
        with:
          repository: llvm-mos/continuous-release
      - name: Inject slug/short variables
        uses: rlespinasse/github-slug-action@v3.x
      - name: Add Microsoft development tools to path
        if: matrix.os == 'windows-self-hosted'
        uses: ilammy/msvc-dev-cmd@v1.5.0
      - name: Configure with cmake
        run: >-
          cmake 
          -DLLVM_MOS_GIT_URL=https://www.github.com/${{ env.GH_REPO }}.git 
          -DLLVM_MOS_GIT_TAG=${{ github.sha }} 
          -DLLVM_MOS_RELEASE_SLUG=${{ env.GITHUB_REF_SLUG }} 
          -DCMAKE_BUILD_TYPE=Release
          -G Ninja
          -S . 
          -B build
      - name: Build with cmake
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          cd build
          cmake --build . --target ship

