//===-- MOSSubtarget.h - Define Subtarget for the MOS -----------*- C++ -*-===//
//
// Part of LLVM-MOS, under the Apache License v2.0 with LLVM Exceptions.
// See https://llvm.org/LICENSE.txt for license information.
// SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception
//
//===----------------------------------------------------------------------===//
//
// This file declares the MOS specific subclass of TargetSubtargetInfo.
//
//===----------------------------------------------------------------------===//

#ifndef LLVM_MOS_SUBTARGET_H
#define LLVM_MOS_SUBTARGET_H

#include "llvm/CodeGen/GlobalISel/InlineAsmLowering.h"
#include "llvm/CodeGen/GlobalISel/InstructionSelector.h"
#include "llvm/CodeGen/GlobalISel/Utils.h"
#include "llvm/CodeGen/Register.h"
#include "llvm/CodeGen/TargetSubtargetInfo.h"
#include "llvm/IR/DataLayout.h"
#include "llvm/Target/TargetMachine.h"

#include "MOSCallLowering.h"
#include "MOSFrameLowering.h"
#include "MOSISelLowering.h"
#include "MOSInlineAsmLowering.h"
#include "MOSInstrInfo.h"
#include "MOSLegalizerInfo.h"
#include "MOSRegisterBankInfo.h"
#include "MOSRegisterInfo.h"

#define GET_SUBTARGETINFO_HEADER
#include "MOSGenSubtargetInfo.inc"

namespace llvm {

class MOSTargetMachine;

/// A specific MOS target MCU.
class MOSSubtarget : public MOSGenSubtargetInfo {
public:
  MOSSubtarget(const Triple &TT, const std::string &CPU, const std::string &FS,
               const MOSTargetMachine &TM);

  /// Gets the e_flags value of an ELF object file.
  unsigned getEFlags() const {
    assert(EFlags != 0 &&
           "every MOS subtarget must set at least one architecture feature");
    return EFlags;
  }

  const MOSFrameLowering *getFrameLowering() const override {
    return &FrameLowering;
  }

  const MOSInstrInfo *getInstrInfo() const override { return &InstrInfo; }

  const MOSRegisterInfo *getRegisterInfo() const override { return &RegInfo; }

  const MOSTargetLowering *getTargetLowering() const override {
    return &TLInfo;
  }

  const CallLowering *getCallLowering() const override {
    return &CallLoweringInfo;
  }

  const LegalizerInfo *getLegalizerInfo() const override { return &Legalizer; }

  const RegisterBankInfo *getRegBankInfo() const override {
    return &RegBankInfo;
  }

  InstructionSelector *getInstructionSelector() const override {
    return InstSelector.get();
  }

  const MOSInlineAsmLowering *getInlineAsmLowering() const override {
    return &InlineAsmLoweringInfo;
  }

  uint16_t getZeroPageOffset() const {
    return hasHUC6280() ? 0x2000 : 0;
  }

  bool enableMachineScheduler() const override { return true; }
  bool enableSubRegLiveness() const override { return true; }

  void overrideSchedPolicy(MachineSchedPolicy &Policy,
                           unsigned NumRegionInstrs) const override;

  bool useAA() const override { return true; }

  // Subtarget feature getters.
  // See MOS.td for details.
  bool hasTinyEncoding() const { return HasTinyEncoding; }

  MOSSubtarget &initializeSubtargetDependencies(StringRef CPU, StringRef FS,
                                                const TargetMachine &TM);

  /// Parses a subtarget feature string, setting appropriate options.
  /// \note Definition of function is auto generated by `tblgen`.
  void ParseSubtargetFeatures(StringRef CPU, StringRef TuneCPU, StringRef FS);

  bool has6502() const { return Has6502Insns; }
  bool has6502X() const { return Has6502XInsns; }
  bool has65C02() const { return Has65C02Insns; }
  bool hasR65C02() const { return HasR65C02Insns; }
  bool hasW65C02() const { return HasW65C02Insns; }
  bool hasW65816() const { return HasW65816Insns; }
  bool has65EL02() const { return Has65EL02Insns; }
  bool has65CE02() const { return Has65CE02Insns; }
  bool hasHUC6280() const { return HasHUC6280Insns; }
  bool has65DTV02() const { return Has65DTV02Insns; }
  bool has4510() const { return Has4510Insns; }
  bool has45GS02() const { return Has45GS02Insns; }
  bool hasSPC700() const { return HasSPC700Insns; }
  bool hasGPRStackRegs() const { return has65C02() || hasSPC700(); }
  bool hasGPRIncDec() const { return has65C02() || hasSPC700(); }
  bool hasBRA() const { return has65C02() || has65DTV02() || hasSPC700(); }
  bool hasJMPIdxIndir() const { return has65C02() || hasSPC700(); }
  bool staticStack() const { return StaticStack; }

  bool hasW65816Or65EL02() const { return HasW65816Insns || Has65EL02Insns; }

private:
  /// The ELF e_flags architecture features.
  unsigned EFlags = 0;

  // Subtarget feature settings
  // See MOS.td for details.
  bool HasTinyEncoding = false;

  bool Has6502Insns = false;
  bool Has6502BCDInsns = false;
  bool Has6502XInsns = false;
  bool Has65C02Insns = false;
  bool HasR65C02Insns = false;
  bool HasW65C02Insns = false;
  bool HasW65816Insns = false;
  bool Has65EL02Insns = false;
  bool Has65CE02Insns = false;
  bool HasHUC6280Insns = false;
  bool HasSWEET16Insns = false;
  bool Has65DTV02Insns = false;
  bool Has4510Insns = false;
  bool Has45GS02Insns = false;
  bool HasSPC700Insns = false;

  bool LongRegisterNames = false;
  bool StaticStack = false;

  // Dummy member, used by FeatureSet's. We cannot have a SubtargetFeature with
  // no variable, so we instead bind pseudo features to this variable.
  bool FeatureSetDummy = false;

  MOSInstrInfo InstrInfo;
  MOSRegisterInfo RegInfo;
  MOSFrameLowering FrameLowering;
  MOSTargetLowering TLInfo;
  MOSCallLowering CallLoweringInfo;
  MOSLegalizerInfo Legalizer;
  MOSRegisterBankInfo RegBankInfo;
  std::unique_ptr<InstructionSelector> InstSelector;
  MOSInlineAsmLowering InlineAsmLoweringInfo;
};

} // end namespace llvm

#endif // LLVM_MOS_SUBTARGET_H
